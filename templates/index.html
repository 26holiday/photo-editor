<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Hue Adjustment</title>
    <style>
        #image-container {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <input type="file" id="image-upload" accept="image/*">
    <div id="color-selector">
        <label for="color-select">Select Color:</label>
        <select id="color-select">
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="blue">Blue</option>
            <!-- Add more color options as needed -->
        </select>
    </div>
    <div id="slider-container">
        <label for="hue-slider">Hue Percentage:</label>
        <input type="range" id="hue-slider" min="0" max="100" value="0">
        <span id="slider-value">0</span>
    </div>
    <div id="image-container">
        <img id="processed-image" src="#" alt="Processed Image">
        <img id="test-image" src="#" alt="test Image">
    </div>
    <button id="refresh-button">Refresh Image</button>

    <script>
        var colorSliderDict = {
            red: 0,
            green: 0,
            blue: 0
        };

        document.getElementById('image-upload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const formData = new FormData();
        formData.append('image', file);
        formData.append('percentage', 0); // Default value for slider
        formData.append('color', 'red'); // Default value for color select
        formData.append('processedImageFilename', ''); // Empty string for processed image filename
        
        console.log('Slider value:', 0);
        console.log('Color:', 'red');
        console.log('Processed image filename:', '');

        fetch('/process_image', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.json(); // Assuming server responds with JSON containing image path
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            const processedImageURL = data.imagePath; // Assuming server responds with image path
            document.getElementById('processed-image').src = processedImageURL;
        })
        .catch(error => console.error('There was a problem with the fetch operation:', error));
    });

    document.getElementById('refresh-button').addEventListener('click', function() {
        var color = document.getElementById('color-select').value;
        var newValue = document.getElementById('hue-slider').value; 
        var processedImageFilename = document.getElementById('processed-image').src.split('/').pop();
        updateProcessedImage(document.getElementById('image-upload').files[0], newValue, color, processedImageFilename);
    });

    document.getElementById('color-select').addEventListener('change', function(event) {
        document.getElementById('hue-slider').value = colorSliderDict[event.target.value];
        document.getElementById('slider-value').textContent = colorSliderDict[event.target.value];
    });

    document.getElementById('hue-slider').addEventListener('input', function(event) {
        var color = document.getElementById('color-select').value;
        var newValue = event.target.value;
        var value = newValue - colorSliderDict[color];
        document.getElementById('slider-value').textContent = newValue;
        colorSliderDict[color] = newValue;
        clearTimeout(timeout);
        var timeout = setTimeout(function() {
            // Send AJAX request to update the processed image with slider value and color select value
            var color = document.getElementById('color-select').value;
            var processedImageFilename = document.getElementById('processed-image').src.split('/').pop();
            updateProcessedImage(null, value, color, processedImageFilename); // Passing null for image data

            console.log('Slider value:', value);
            console.log('Color:', color);
            console.log('Processed image filename:', processedImageFilename);
        }, 500);
        // // Send AJAX request to update the processed image with slider value and color select value
        // var color = document.getElementById('color-select').value;
        // var processedImageFilename = document.getElementById('processed-image').src.split('/').pop();
        // updateProcessedImage(null, value, color, processedImageFilename); // Passing null for image data

        // console.log('Slider value:', value);
        // console.log('Color:', color);
        // console.log('Processed image filename:', processedImageFilename);

        // // Store the slider value to localStorage
        // storeDataToLocalStorage(oldValue, newValue, color, processedImageFilename);
    });

    function updateProcessedImage(imageData, sliderValue, colorValue, processedImageFilename) {
        // Create FormData object
        var formData = new FormData();

        // Append image data if provided
        if (imageData !== null) {
            formData.append('image', imageData);
        }

        // Append slider value
        formData.append('percentage', sliderValue);

        // Append color select value
        formData.append('color', colorValue);

        // Append processed image filename
        formData.append('processedImageFilename', processedImageFilename);
        
        fetch('processed/' + processedImageFilename, {
            method: 'GET'
            })
            .then(response => {
                if (response.ok) {
                    // Update the src attribute of the test-image element with the new URL
                    // document.getElementById('test-image').src = 'processed/' + processedImageFilename;
                }
                throw new Error('Network response was not ok.');
            })
            .catch(error => console.error('There was a problem with the fetch operation:', error));


        // Send AJAX request to backend with FormData
        fetch('/process_image', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok.');
        })
        .then(data => {
            const processedImageURL = data.imagePath;
            // document.getElementById('processed-image').src = processedImageURL;
            document.getElementById('test-image').src = processedImageURL;
            console.log('Processed image updated successfully:', processedImageURL);
        })
        .catch(error => console.error('There was a problem with the fetch operation:', error));
        }
    </script>
</body>
</html>
